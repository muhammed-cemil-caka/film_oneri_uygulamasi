using System;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.Drawing;
using System.Linq;
using System.Windows.Forms;
using DevExpress.XtraEditors;
using DevExpress.XtraGrid.Views.Grid;
using DevExpress.Utils;
using System.Text.RegularExpressions;

namespace DXApplication1
{
    public partial class Form1 : DevExpress.XtraBars.Ribbon.RibbonForm
    {
        // Yıldız görselleri (Favori sütunu için)
        private Bitmap _emptyStar;
        private Bitmap _filledStar;

        // Durum değişkenleri
        private int? _lastRecommendedId = null;
        private HashSet<int> _top5Ids = new HashSet<int>();
        // When user filters by ID in the auto-filter row, keep that value here
        private int? _activeIdFilter = null;
        // Track the active auto-filter editor so we can react to Enter/Leave
        private DevExpress.XtraEditors.BaseEdit _activeAutoFilterEditor = null;
        // UI buttons added at runtime
        private DevExpress.XtraEditors.SimpleButton btnFavorites;
        private DevExpress.XtraEditors.SimpleButton btnBackFavorites;

        public Form1()
        {
            InitializeComponent();

            // Form başlangıçta tam ekran
            try { this.WindowState = FormWindowState.Maximized; } catch { }

            // ESC ile kapatma
            this.KeyPreview = true;
            this.KeyDown += Form1_KeyDown;

            try { gridControl1.Dock = DockStyle.Fill; } catch { }

            EnsureStarImages();

            AddDetailPanelToUI();

            // Veriyi yükle
            LoadData();

            // Favoriler ve Geri butonlarını programatik olarak ekle
            try
            {
                // Style runtime buttons to align with btnRecommend
                btnFavorites = new DevExpress.XtraEditors.SimpleButton();
                btnFavorites.Text = "Favoriler";
                btnFavorites.Size = new System.Drawing.Size(140, 44);
                // align baseline with designer btnRecommend (which is at Y=162)
                btnFavorites.Location = new System.Drawing.Point(290 + 160 + 12, 162);
                btnFavorites.Appearance.Font = new System.Drawing.Font("Segoe UI", 10F, System.Drawing.FontStyle.Regular);
                btnFavorites.Appearance.ForeColor = System.Drawing.Color.White;
                btnFavorites.Appearance.Options.UseFont = true;
                btnFavorites.Appearance.Options.UseForeColor = true;
                btnFavorites.Appearance.BackColor = System.Drawing.Color.FromArgb(60, 60, 60);
                btnFavorites.Appearance.Options.UseBackColor = true;
                btnFavorites.LookAndFeel.UseDefaultLookAndFeel = false;
                btnFavorites.LookAndFeel.Style = DevExpress.LookAndFeel.LookAndFeelStyle.Style3D;
                btnFavorites.Click += BtnFavorites_Click;
                this.Controls.Add(btnFavorites);

                btnBackFavorites = new DevExpress.XtraEditors.SimpleButton();
                btnBackFavorites.Text = "Geri";
                btnBackFavorites.Size = new System.Drawing.Size(100, 44);
                btnBackFavorites.Location = new System.Drawing.Point(btnFavorites.Location.X + btnFavorites.Width + 12, btnFavorites.Location.Y);
                btnBackFavorites.Appearance.Font = new System.Drawing.Font("Segoe UI", 10F, System.Drawing.FontStyle.Regular);
                btnBackFavorites.Appearance.ForeColor = System.Drawing.Color.Black;
                btnBackFavorites.Appearance.Options.UseFont = true;
                btnBackFavorites.Appearance.Options.UseForeColor = true;
                btnBackFavorites.Appearance.BackColor = System.Drawing.Color.FromArgb(245, 245, 245);
                btnBackFavorites.Appearance.Options.UseBackColor = true;
                btnBackFavorites.LookAndFeel.UseDefaultLookAndFeel = false;
                btnBackFavorites.LookAndFeel.Style = DevExpress.LookAndFeel.LookAndFeelStyle.Style3D;
                btnBackFavorites.Click += BtnBackFavorites_Click;
                btnBackFavorites.Enabled = false;
                this.Controls.Add(btnBackFavorites);
            }
            catch { }
        }

        // When grid auto-filter row changes (user clears filter with the UI), ensure our id filter state is consistent
        private void GridView_ColumnFilterChanged(object sender, EventArgs e)
        {
            try
            {
                var gv = sender as GridView; if (gv == null) return;
                // If the active filter string no longer contains an exact id filter, clear our state
                if (string.IsNullOrWhiteSpace(gv.ActiveFilterString) || !Regex.IsMatch(gv.ActiveFilterString, "\\[id\\]\\s*=\\s*\\d+"))
                {
                    _activeIdFilter = null;
                    gv.RefreshData();
                }
                else
                {
                    // extract id from filter string
                    var m = Regex.Match(gv.ActiveFilterString, "\\[id\\]\\s*=\\s*(\\d+)");
                    if (m.Success && int.TryParse(m.Groups[1].Value, out int idVal)) _activeIdFilter = idVal;
                }
            }
            catch { }
        }

        private void GridView_ShownEditor(object sender, EventArgs e)
        {
            try
            {
                var view = sender as GridView; if (view == null) return;
                var col = view.FocusedColumn; if (col == null) return;
                // If user started editing the auto-filter cell for our display_id column
                if (string.Equals(col.FieldName, "display_id", StringComparison.OrdinalIgnoreCase) && view.ActiveEditor != null)
                {
                    // track editor and hook enter/leave
                    _activeAutoFilterEditor = view.ActiveEditor as DevExpress.XtraEditors.BaseEdit;
                    if (_activeAutoFilterEditor != null)
                    {
                        _activeAutoFilterEditor.KeyDown -= AutoFilterEditor_KeyDown; _activeAutoFilterEditor.KeyDown += AutoFilterEditor_KeyDown;
                        _activeAutoFilterEditor.Leave -= AutoFilterEditor_Leave; _activeAutoFilterEditor.Leave += AutoFilterEditor_Leave;
                    }
                }
            }
            catch { }
        }

        private void AutoFilterEditor_KeyDown(object sender, KeyEventArgs e)
        {
            try
            {
                if (e.KeyCode == Keys.Enter)
                {
                    ApplyIdFilterFromEditor();
                }
            }
            catch { }
        }

        private void AutoFilterEditor_Leave(object sender, EventArgs e)
        {
            try { ApplyIdFilterFromEditor(); } catch { }
        }

        private void ApplyIdFilterFromEditor()
        {
            try
            {
                if (_activeAutoFilterEditor == null) return;
                var txt = _activeAutoFilterEditor.EditValue?.ToString();
                _activeAutoFilterEditor.KeyDown -= AutoFilterEditor_KeyDown; _activeAutoFilterEditor.Leave -= AutoFilterEditor_Leave;
                _activeAutoFilterEditor = null;

                if (string.IsNullOrWhiteSpace(txt)) { ClearIdFilter(); return; }
                if (int.TryParse(txt.Trim(), out int idVal))
                {
                    _activeIdFilter = idVal;
                    ApplyIdFilter(idVal);
                }
                else
                {
                    ClearIdFilter();
                }
            }
            catch { }
        }

        private void ApplyIdFilter(int id)
        {
            try
            {
                var gv = this.gridView1;
                if (gv == null) return;
                // apply filter on hidden real id column
                gv.ActiveFilterString = $"[id] = {id}";
                // refresh so CustomUnboundColumnData still provides sequential numbers but
                // we want to display the real DB id for the single-row result — so temporarily
                // set display_id's FieldName to 'id' when exact-id filter is active.
                // Keep the visible column as the unbound "display_id" column. CustomUnboundColumnData
                // will return the real DB id when _activeIdFilter is set, so no need to rebind the column.
                _activeIdFilter = id;
                gv.RefreshData();
            }
            catch { }
        }

        private void ClearIdFilter()
        {
            try
            {
                var gv = this.gridView1; if (gv == null) return;
                _activeIdFilter = null;
                gv.ActiveFilterString = string.Empty;
                _activeIdFilter = null;
                gv.RefreshData();
            }
            catch { }
        }
        
        // Draw a star at the end of the movie_name cell to indicate favorite status


        
        // Draw a star at the end of the movie_name cell to indicate favorite status
        private void GridView_CustomDrawMovieNameCell(object sender, DevExpress.XtraGrid.Views.Base.RowCellCustomDrawEventArgs e)
        {
            try
            {
                // Only draw movie name text here (remove star drawing from this cell)
                if (e.Column == null || !string.Equals(e.Column.FieldName, "movie_name", StringComparison.OrdinalIgnoreCase)) return;
                var view = sender as GridView;
                if (view == null) return;
                // let default draw occur first
                // draw star on the right side of the cell
                var idObj = view.GetRowCellValue(e.RowHandle, "id");
                bool isFav = false;
                try { if (idObj != null && idObj != DBNull.Value) isFav = DatabaseHelper.Instance.IsFavorite(Convert.ToInt32(idObj)); } catch { }

                // draw only text (fill full width)
                var rect = e.Bounds;
                e.Appearance.DrawString(e.Cache, e.DisplayText, new Rectangle(rect.Left + 4, rect.Top, rect.Width - 8, rect.Height));
                e.Handled = true;
            }
            catch { }
        }

        private void GridView_CustomDrawFavoriteCell(object sender, DevExpress.XtraGrid.Views.Base.RowCellCustomDrawEventArgs e)
        {
            try
            {
                if (e.Column == null || !string.Equals(e.Column.FieldName, "is_favorite", StringComparison.OrdinalIgnoreCase)) return;
                var view = sender as GridView; if (view == null) return;
                var idObj = view.GetRowCellValue(e.RowHandle, "id");
                bool isFav = false;
                try { if (idObj != null && idObj != DBNull.Value) isFav = DatabaseHelper.Instance.IsFavorite(Convert.ToInt32(idObj)); } catch { }

                var rect = e.Bounds;
                int size = 16;
                var starRect = new Rectangle(rect.Left + (rect.Width - size) / 2, rect.Top + (rect.Height - size) / 2, size, size);
                try
                {
                    var bmp = isFav ? _filledStar : _emptyStar;
                    if (bmp != null) e.Graphics.DrawImage(bmp, starRect);
                }
                catch { }
                e.Handled = true;
            }
            catch { }
        }

        private void GridView_DoubleClick(object sender, EventArgs e)
        {
            try
            {
                var view = sender as GridView; if (view == null) return;
                var hi = view.CalcHitInfo(view.GridControl.PointToClient(MousePosition));
                if (hi == null || hi.RowHandle < 0) return;
                var row = view.GetDataRow(hi.RowHandle); if (row == null) return;
                if (row.Table.Columns.Contains("id") && !row.IsNull("id"))
                {
                    int id = Convert.ToInt32(row["id"]);
                    string name = row.Table.Columns.Contains("movie_name") && !row.IsNull("movie_name") ? row.Field<string>("movie_name") : string.Empty;
                    double rating = row.Table.Columns.Contains("rating") && !row.IsNull("rating") ? Convert.ToDouble(row["rating"]) : 0.0;
                    // try to pass genre for the dialog so "Başka Öner" can work
                    string genre = row.Table.Columns.Contains("genre") && !row.IsNull("genre") ? row.Field<string>("genre") : null;
                    ShowRecommendationDialog(name, rating, id, genre);
                }
            }
            catch { }
        }

        // Sadece rating hücrelerini renklendirir
        private void GridView_CustomDrawRatingCell(object sender, DevExpress.XtraGrid.Views.Base.RowCellCustomDrawEventArgs e)
        {
            try
            {
                if (e.Column == null || !string.Equals(e.Column.FieldName, "rating", StringComparison.OrdinalIgnoreCase)) return;
                object val = gridView1.GetRowCellValue(e.RowHandle, "rating"); double rating = 0.0; try { if (val != null && val != DBNull.Value) rating = Convert.ToDouble(val); } catch { }
                if (rating >= 8.5) e.Appearance.BackColor = Color.FromArgb(235, 248, 236);
                else if (rating >= 7.0) e.Appearance.BackColor = Color.FromArgb(255, 252, 230);
                else e.Appearance.BackColor = Color.FromArgb(255, 241, 243);
                // center rating text
                e.Appearance.TextOptions.HAlignment = HorzAlignment.Center;
            }
            catch { }
        }

        // Designer tarafından çağrılan stub
        private void Form1_Load(object sender, EventArgs e)
        {
            // Yükleme constructor içinde zaten yapıldı; yine de stub mevcut olsun
        }

        private void LoadData()
        {
            try
            {
                var dt = DatabaseHelper.Instance.GetMovies();
                // Film isimlerini Türkçe yapma mantığı
                try
                {
                    if (dt != null && dt.Rows.Count > 0 && dt.Columns.Contains("movie_name"))
                    {
                        for (int i = 0; i < dt.Rows.Count; i++)
                        {
                            var row = dt.Rows[i];
                            try
                            {
                                var en = row.Field<string>("movie_name");
                                var tr = DatabaseHelper.Instance.GetTurkishMovieName(en);
                                if (!string.IsNullOrWhiteSpace(tr)) row["movie_name"] = tr;
                            }
                            catch { }
                        }
                    }
                }
                catch { }

                gridControl1.DataSource = dt;
                ConfigureGrid(dt);
                UpdateTop5FromDataSource();

                // Tür listesini doldur
                try
                {
                    if (comboBoxGenres.Items.Count <= 1)
                    {
                        comboBoxGenres.Items.Clear();
                        comboBoxGenres.Items.Add("Hepsi");
                        foreach (var g in DatabaseHelper.Instance.GetDistinctGenres())
                            comboBoxGenres.Items.Add(g);
                        comboBoxGenres.SelectedIndex = 0;
                    }
                }
                catch { }
            }
            catch (Exception ex)
            {
                DevExpress.XtraEditors.XtraMessageBox.Show($"Veri yüklenirken hata: {ex.Message}", "Hata", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // --- YENİ: SAĞ TARAF DETAY PANELİ ---
        private void AddDetailPanelToUI()
        {
            // Sağ Panel Konteyneri
            var sidePanel = new DevExpress.XtraEditors.PanelControl();
            sidePanel.Dock = DockStyle.Right;
            sidePanel.Width = 350; // Sağ taraftaki boşluğu kapatan genişlik
            sidePanel.Appearance.BackColor = Color.FromArgb(240, 240, 240);
            this.Controls.Add(sidePanel);

            // Film Adı Başlığı
            var lblTitle = new DevExpress.XtraEditors.LabelControl();
            lblTitle.Name = "lblDetailTitle";
            lblTitle.Text = "Film Seçiniz";
            lblTitle.Appearance.Font = new Font("Tahoma", 12, FontStyle.Bold);
            lblTitle.Location = new Point(15, 20);
            lblTitle.AutoSizeMode = DevExpress.XtraEditors.LabelAutoSizeMode.Vertical;
            lblTitle.Size = new Size(320, 0);
            sidePanel.Controls.Add(lblTitle);

            // Film Konusu (Plot)
            var txtPlot = new DevExpress.XtraEditors.MemoEdit();
            txtPlot.Name = "txtDetailPlot";
            txtPlot.Properties.ReadOnly = true;
            txtPlot.Properties.BorderStyle = DevExpress.XtraEditors.Controls.BorderStyles.NoBorder;
            txtPlot.Properties.Appearance.BackColor = Color.Transparent;
            txtPlot.Size = new Size(320, 450);
            txtPlot.Location = new Point(15, 70);
            sidePanel.Controls.Add(txtPlot);

            // Grid üzerinde seçim değiştikçe paneli güncelle
            gridView1.FocusedRowChanged += (s, e) => {
                var movieName = gridView1.GetFocusedRowCellValue("movie_name")?.ToString();
                var plot = gridView1.GetFocusedRowCellValue("plot")?.ToString();
                lblTitle.Text = movieName ?? "Seçim Yok";
                txtPlot.Text = plot ?? "Bu film için konu özeti bulunamadı.";
            };
        }

        private void ConfigureGrid(DataTable dt)
        {
            try
            {
                // Liste görünümüne dön
                try { gridControl1.MainView = gridView1; gridControl1.ForceInitialize(); } catch { }

                var gv = this.gridView1;
                gv.Columns.Clear();
                // Clear any previous sorting/grouping/filter state so columns reflect datasource order
                try
                {
                    gv.SortInfo.Clear();
                    gv.ClearGrouping();
                    try { gv.ActiveFilter.Clear(); } catch { gv.ActiveFilterString = string.Empty; }
                }
                catch { }

                // Real DB id column (hidden, used for operations)
                var colDbId = gv.Columns.AddField("id");
                colDbId.FieldName = "id";
                colDbId.Caption = "DB_ID";
                colDbId.Visible = false;
                colDbId.OptionsColumn.AllowEdit = false;

                // Visible display ID column: show a sequential index for visible rows (no gaps)
                var colDisplayId = gv.Columns.AddVisible("display_id", "ID");
                colDisplayId.UnboundType = DevExpress.Data.UnboundColumnType.Integer;
                colDisplayId.OptionsColumn.AllowEdit = false;
                colDisplayId.Width = 75;
                colDisplayId.OptionsColumn.FixedWidth = true;
                colDisplayId.AppearanceCell.TextOptions.HAlignment = HorzAlignment.Center;
                colDisplayId.AppearanceHeader.TextOptions.HAlignment = HorzAlignment.Center;
                colDisplayId.AppearanceHeader.Font = new System.Drawing.Font(colDisplayId.AppearanceHeader.Font, System.Drawing.FontStyle.Bold);
                colDisplayId.AppearanceHeader.ForeColor = System.Drawing.Color.Black;
                // Always use unbound sequential numbering to avoid gaps caused by DB ids
                gv.CustomUnboundColumnData -= gridView1_CustomUnboundColumnData; gv.CustomUnboundColumnData += gridView1_CustomUnboundColumnData;
                // monitor auto-filter editor openings to support typing a DB id
                gv.ShownEditor -= GridView_ShownEditor; gv.ShownEditor += GridView_ShownEditor;
                // ensure we can correct/filter when auto-filter row logic overrides our filter
                gv.ColumnFilterChanged -= GridView_ColumnFilterChanged; gv.ColumnFilterChanged += GridView_ColumnFilterChanged;

                // place Genre and Rating between DB_ID and Film Name
                var colGenre = gv.Columns.AddVisible("genre", "TÜR"); colGenre.OptionsColumn.AllowEdit = false; colGenre.Width = 300;
                colGenre.AppearanceCell.TextOptions.HAlignment = HorzAlignment.Center;
                colGenre.AppearanceHeader.TextOptions.HAlignment = HorzAlignment.Center;
                colGenre.AppearanceHeader.Font = new System.Drawing.Font(colGenre.AppearanceHeader.Font, System.Drawing.FontStyle.Bold);
                colGenre.AppearanceHeader.ForeColor = System.Drawing.Color.Black;

                var colRating = gv.Columns.AddVisible("rating", "PUAN"); colRating.OptionsColumn.AllowEdit = false; colRating.Width = 60;
                colRating.AppearanceHeader.TextOptions.HAlignment = HorzAlignment.Center;
                colRating.AppearanceHeader.Font = new System.Drawing.Font(colRating.AppearanceHeader.Font, System.Drawing.FontStyle.Bold);
                colRating.AppearanceHeader.ForeColor = System.Drawing.Color.Black;

                var colName = gv.Columns.AddVisible("movie_name", "FİLMLER"); colName.OptionsColumn.AllowEdit = false; colName.Width = 900;
                // Header style for movie name
                colName.AppearanceHeader.TextOptions.HAlignment = HorzAlignment.Center;
                colName.AppearanceHeader.Font = new System.Drawing.Font(colName.AppearanceHeader.Font, System.Drawing.FontStyle.Bold);
                colName.AppearanceHeader.ForeColor = System.Drawing.Color.Black;

                // Add favorite column immediately to the right of movie_name
                var colFav = gv.Columns.AddVisible("is_favorite", "FAVORİ"); colFav.OptionsColumn.AllowEdit = false; colFav.Width = 60;
                colFav.AppearanceHeader.TextOptions.HAlignment = HorzAlignment.Center;
                colFav.AppearanceHeader.Font = new System.Drawing.Font(colFav.AppearanceHeader.Font, System.Drawing.FontStyle.Bold);
                colFav.AppearanceHeader.ForeColor = System.Drawing.Color.Black;
                colFav.AppearanceCell.TextOptions.HAlignment = HorzAlignment.Center;

                // Favori sütunu: yıldız simgesini bu sütunda göstereceğiz ve tıklamayı burada yakalayacağız
                EnsureStarImages();

                // Custom draw for the favorite column to show star
                gv.CustomDrawCell -= GridView_CustomDrawFavoriteCell; gv.CustomDrawCell += GridView_CustomDrawFavoriteCell;

                gv.OptionsView.ShowIndicator = false;
                // Improve filtering UX: Excel-style popup and visible auto-filter row
                try
                {
                    gv.OptionsFilter.ColumnFilterPopupMode = DevExpress.XtraGrid.Columns.ColumnFilterPopupMode.Excel;
                    gv.OptionsView.ShowAutoFilterRow = true;
                    gv.OptionsView.ShowFilterPanelMode = DevExpress.XtraGrid.Views.Base.ShowFilterPanelMode.Never;
                }
                catch { }
                // Use explicit widths so film name column stays wide and genre/rating remain narrow
                gv.OptionsView.ColumnAutoWidth = false;
                // Increase row height and fonts for better readability and to occupy more horizontal space
                try
                {
                    gv.RowHeight = 30;
                    gv.Appearance.Row.Font = new System.Drawing.Font("Segoe UI", 10);
                    gv.Appearance.HeaderPanel.Font = new System.Drawing.Font("Segoe UI", 10, System.Drawing.FontStyle.Bold);
                    // make header visually distinct and centered
                    gv.Appearance.HeaderPanel.BackColor = Color.FromArgb(250, 250, 250);
                    gv.Appearance.HeaderPanel.ForeColor = Color.FromArgb(45, 45, 45);
                    gv.Appearance.HeaderPanel.TextOptions.HAlignment = HorzAlignment.Center;
                    try { gv.ColumnPanelRowHeight = 34; } catch { }
                }
                catch { }

                // CustomUnboundColumnData attached conditionally above when needed
                // Custom draw handlers: rating cell coloring + favorite column star icon
                gv.CustomDrawCell -= GridView_CustomDrawRatingCell; gv.CustomDrawCell += GridView_CustomDrawRatingCell;

                // RowStyle not subscribed: coloring will be applied only on rating cells via CustomDrawCell

                // Favori değişikliği yakalama
                gv.CellValueChanged -= GridView_CellValueChanged; gv.CellValueChanged += GridView_CellValueChanged;
                // Double click to open recommendation / detail dialog for the clicked movie
                gv.DoubleClick -= GridView_DoubleClick; gv.DoubleClick += GridView_DoubleClick;
                // Ensure favorite column fills remaining horizontal space up to the scrollbar
                try
                {
                    AdjustFavoriteColumnWidth();
                    gridControl1.SizeChanged -= GridControl1_SizeChanged_AdjustFav; gridControl1.SizeChanged += GridControl1_SizeChanged_AdjustFav;
                    gv.ColumnWidthChanged -= GridView_ColumnWidthChanged_AdjustFav; gv.ColumnWidthChanged += GridView_ColumnWidthChanged_AdjustFav;
                }
                catch { }
            }
            catch { }
        }

        private void GridControl1_SizeChanged_AdjustFav(object? sender, EventArgs e)
        {
            try { AdjustFavoriteColumnWidth(); } catch { }
        }

        private void GridView_ColumnWidthChanged_AdjustFav(object? sender, DevExpress.XtraGrid.Views.Base.ColumnEventArgs e)
        {
            try { AdjustFavoriteColumnWidth(); } catch { }
        }

        private void AdjustFavoriteColumnWidth()
        {
            try
            {
                var gv = this.gridView1;
                if (gv == null || gv.Columns == null || gv.GridControl == null) return;
                var colFav = gv.Columns.FirstOrDefault(c => string.Equals(c.FieldName, "is_favorite", StringComparison.OrdinalIgnoreCase));
                if (colFav == null) return;

                int totalWidth = gv.GridControl.ClientSize.Width;
                int reserved = gv.IndicatorWidth + SystemInformation.VerticalScrollBarWidth;

                int otherColsWidth = 0;
                foreach (DevExpress.XtraGrid.Columns.GridColumn c in gv.Columns)
                {
                    if (!c.Visible) continue;
                    if (object.ReferenceEquals(c, colFav)) continue;
                    otherColsWidth += (c.Width > 0 ? c.Width : 80);
                }

                int remaining = totalWidth - reserved - otherColsWidth;
                // small fudge so it reaches the scrollbar edge
                remaining += 6;
                if (remaining < 40) remaining = 40;
                colFav.Width = remaining;
                gv.OptionsView.ColumnAutoWidth = false;
            }
            catch { }
        }

        private void gridView1_CustomUnboundColumnData(object sender, DevExpress.XtraGrid.Views.Base.CustomColumnDataEventArgs e)
        {
            try
            {
                if (e.Column == null) return;
                if (e.Column.FieldName == "display_id" && e.IsGetData)
                {
                    // If user applied an exact id filter, prefer showing the real DB id for
                    // the rows (so typing an id in the auto-filter shows that id rather than
                    // the sequential index). Otherwise show a sequential index that reflects
                    // the visible order (no gaps).
                    var view = sender as GridView;
                    try
                    {
                        if (view != null)
                        {
                            int rowHandle = view.GetRowHandle(e.ListSourceRowIndex);
                            // when an id filter is active and the real id is available for this row,
                            // display it
                            if (_activeIdFilter != null && rowHandle >= 0)
                            {
                                var idVal = view.GetRowCellValue(rowHandle, "id");
                                if (idVal != null && idVal != DBNull.Value)
                                {
                                    e.Value = Convert.ToInt32(idVal);
                                    return;
                                }
                            }

                            if (rowHandle >= 0)
                            {
                                int visibleIndex = view.GetVisibleIndex(rowHandle);
                                if (visibleIndex >= 0)
                                {
                                    e.Value = visibleIndex + 1;
                                    return;
                                }
                            }
                        }
                    }
                    catch { }

                    // fallback to list source index when visible index cannot be resolved
                    e.Value = e.ListSourceRowIndex + 1;
                }
            }
            catch { }
        }

        // Hem GridView1_RowStyle hem de gridView1_RowStyle ekleniyor (küçük/büyük harf uyumu için)
        private void GridView1_RowStyle(object sender, DevExpress.XtraGrid.Views.Grid.RowStyleEventArgs e)
        {
            ApplyRatingRowStyle(sender as GridView, e);
        }
        private void gridView1_RowStyle(object sender, DevExpress.XtraGrid.Views.Grid.RowStyleEventArgs e)
        {
            ApplyRatingRowStyle(sender as GridView, e);
        }

        private void ApplyRatingRowStyle(GridView view, DevExpress.XtraGrid.Views.Grid.RowStyleEventArgs e)
        {
            try
            {
                if (view == null) return;
                if (e.RowHandle < 0) return;
                object val = view.GetRowCellValue(e.RowHandle, "rating"); double rating = 0.0; try { if (val != null && val != DBNull.Value) rating = Convert.ToDouble(val); } catch { }
                if (rating >= 8.5) e.Appearance.BackColor = Color.FromArgb(235, 248, 236); // pastel yeşil
                else if (rating >= 7.0) e.Appearance.BackColor = Color.FromArgb(255, 252, 230); // pastel sarı
                else e.Appearance.BackColor = Color.FromArgb(255, 241, 243); // pastel kırmızı
            }
            catch { }
        }

        // Favori sütunu değiştiğinde DB'ye kaydet
        private void GridView_CellValueChanged(object sender, DevExpress.XtraGrid.Views.Base.CellValueChangedEventArgs e)
        {
            try
            {
                if (e.Column == null) return;
                if (e.Column.FieldName != "is_favorite") return;
                var view = sender as GridView; if (view == null) return;
                var row = view.GetDataRow(e.RowHandle); if (row == null) return;
                if (!row.Table.Columns.Contains("id") || row.IsNull("id")) return;
                int id = Convert.ToInt32(row["id"]);
                bool val = false; try { val = Convert.ToBoolean(e.Value); } catch { }
                DatabaseHelper.Instance.UpdateFavoriteStatus(id, val);
                UpdateTop5FromDataSource();
            }
            catch { }
        }

        // Designer'ın bağladığı click stub
        private void gridControl1_Click(object sender, EventArgs e)
        {
            // Stub - gerektiğinde genişletilebilir
        }

        private void gridControl1_MouseUp(object sender, MouseEventArgs e)
        {
            try
            {
                var gc = sender as DevExpress.XtraGrid.GridControl;
                if (gc == null) return;
                var view = gc.MainView as GridView;
                if (view == null) return;
                // use the event location (already in gridControl coordinates)
                var pt = e.Location;
                var hi = view.CalcHitInfo(pt);
                if (hi == null || hi.RowHandle < 0 || hi.Column == null) return;
                // Only handle clicks on favorite column — toggle when the favorite cell is clicked
                if (!string.Equals(hi.Column.FieldName, "is_favorite", StringComparison.OrdinalIgnoreCase)) return;

                var idObj = view.GetRowCellValue(hi.RowHandle, "id");
                if (idObj == null || idObj == DBNull.Value) return;
                int id = Convert.ToInt32(idObj);
                try
                {
                    bool currently = DatabaseHelper.Instance.IsFavorite(id);
                    DatabaseHelper.Instance.UpdateFavoriteStatus(id, !currently);
                }
                catch { }
                // refresh view
                view.RefreshRow(hi.RowHandle);
            }
            catch { }
        }

        private void BtnFavorites_Click(object? sender, EventArgs e)
        {
            try
            {
                var dt = DatabaseHelper.Instance.GetFavoriteMovies();
                gridControl1.DataSource = dt; ConfigureGrid(dt); UpdateTop5FromDataSource();
                btnFavorites.Enabled = false; btnBackFavorites.Enabled = true;
            }
            catch { }
        }

        private void BtnBackFavorites_Click(object? sender, EventArgs e)
        {
            try
            {
                LoadData();
                btnFavorites.Enabled = true; btnBackFavorites.Enabled = false;
            }
            catch { }
        }

        // Öneri butonu
        private void BtnRecommend_Click(object sender, EventArgs e)
        {
            try
            {
                var sel = comboBoxGenres.SelectedItem as string ?? string.Empty;
                // Allow "Hepsi" to work as a wildcard (request all genres)
                if (string.Equals(sel, "Hepsi", StringComparison.OrdinalIgnoreCase)) sel = string.Empty;
                var movie = DatabaseHelper.Instance.GetRandomMovieByGenre(sel, _lastRecommendedId);
                if (movie == null) { XtraMessageBox.Show("Seçilen türe ait film bulunamadı.", "Bilgi"); return; }
                _lastRecommendedId = movie.Value.id;

                // Öneri dialogu
                ShowRecommendationDialog(movie.Value.name, movie.Value.rating, movie.Value.id, sel);
            }
            catch { }
        }

        private void ShowRecommendationDialog(string name, double rating, int? id = null, string? genre = null)
        {
            using var dlg = new XtraForm();
            // allow ESC to close the dialog
            dlg.KeyPreview = true;
            dlg.KeyDown += (s, e) => { try { if (e.KeyCode == System.Windows.Forms.Keys.Escape) dlg.Close(); } catch { } };
            dlg.Text = "Film Önerisi";
            dlg.StartPosition = FormStartPosition.CenterParent;
            // Adjusted size to focus on title/rating and action buttons
            dlg.Size = new Size(620, 260);
            dlg.FormBorderStyle = FormBorderStyle.FixedDialog;

            // Top area: cinematic icons and title/rating centered
            var topPanel = new Panel { Dock = DockStyle.Top, Height = 140, BackColor = Color.FromArgb(30, 30, 30) };

            // Decorative cinematic icon (simple film strip drawn into PictureBox)
            // Create a nicer clapperboard-like icon programmatically
            var pic = new PictureBox { Size = new Size(96, 96), Location = new Point(18, 18), SizeMode = PictureBoxSizeMode.CenterImage };
            var bmp = new Bitmap(96, 96);
            using (var g = Graphics.FromImage(bmp))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
                g.Clear(Color.Transparent);
                // body (rounded rectangle)
                using var bodyBrush = new SolidBrush(Color.FromArgb(40, 40, 40));
                using (var path = new System.Drawing.Drawing2D.GraphicsPath())
                {
                    int x = 12, y = 30, w = 72, h = 46, r = 8;
                    path.AddArc(x, y, r * 2, r * 2, 180, 90);
                    path.AddArc(x + w - r * 2, y, r * 2, r * 2, 270, 90);
                    path.AddArc(x + w - r * 2, y + h - r * 2, r * 2, r * 2, 0, 90);
                    path.AddArc(x, y + h - r * 2, r * 2, r * 2, 90, 90);
                    path.CloseFigure();
                    g.FillPath(bodyBrush, path);
                }
                // top clapper (angled stripes)
                using var topBrush = new SolidBrush(Color.FromArgb(60, 60, 60));
                var topRect = new System.Drawing.Drawing2D.GraphicsPath();
                topRect.AddPolygon(new PointF[] { new(8, 24), new(88, 12), new(84, 20), new(12, 34) });
                g.FillPath(topBrush, topRect);
                // stripes
                using var stripeBrush = new SolidBrush(Color.FromArgb(200, 200, 200));
                for (int i = 0; i < 4; i++)
                    g.FillRectangle(stripeBrush, 16 + i * 14, 18, 8, 6);
                // play triangle in center
                using var playBrush = new SolidBrush(Color.FromArgb(255, 215, 64));
                var tri = new PointF[] { new(44, 42), new(64, 50), new(44, 58) };
                g.FillPolygon(playBrush, tri);
                using var borderPen = new Pen(Color.FromArgb(220, 220, 220), 1f);
                g.DrawPolygon(borderPen, tri);
            }
            pic.Image = bmp;
            topPanel.Controls.Add(pic);

            // Mutable state for the currently displayed suggestion so buttons operate on the latest
            string currentName = name ?? string.Empty;
            double currentRating = rating;
            int? currentId = id;

            var titleLbl = new Label();
            titleLbl.Text = currentName; titleLbl.ForeColor = Color.White; titleLbl.Font = new Font("Segoe UI", 20, FontStyle.Bold);
            titleLbl.AutoSize = false; titleLbl.TextAlign = ContentAlignment.MiddleCenter; titleLbl.Location = new Point(130, 12); titleLbl.Size = new Size(460, 52);
            topPanel.Controls.Add(titleLbl);

            var ratingLbl = new Label(); ratingLbl.Text = $"IMDb: {currentRating:0.0}"; ratingLbl.ForeColor = Color.LightGoldenrodYellow; ratingLbl.Font = new Font("Segoe UI", 14, FontStyle.Regular);
            ratingLbl.AutoSize = false; ratingLbl.TextAlign = ContentAlignment.MiddleCenter; ratingLbl.Location = new Point(130, 70); ratingLbl.Size = new Size(460, 28);
            topPanel.Controls.Add(ratingLbl);
            // Bottom-right action buttons
            var btnWatch = new DevExpress.XtraEditors.SimpleButton();
            btnWatch.Text = "İZLE";
            btnWatch.Size = new Size(160, 48);
            btnWatch.Appearance.Font = new Font("Segoe UI", 12, FontStyle.Bold);
            btnWatch.Appearance.ForeColor = Color.White;
            try { btnWatch.Appearance.BackColor = Color.FromArgb(220, 80, 80); } catch { }
            btnWatch.Margin = new Padding(8, 6, 8, 6);
            // Use the current displayed movie when opening
            btnWatch.Click += (s, e) =>
            {
                try
                {
                    var query = System.Net.WebUtility.UrlEncode(currentName + " imdb izle");
                    var url = $"https://www.google.com/search?q={query}";
                    Process.Start(new ProcessStartInfo { FileName = url, UseShellExecute = true });
                }
                catch { }
            };

            var btnAnother = new DevExpress.XtraEditors.SimpleButton();
            btnAnother.Text = "Başka Öner";
            // Make same size as İZLE for visual parity
            btnAnother.Size = new Size(160, 48);
            btnAnother.Appearance.Font = new Font("Segoe UI", 11, FontStyle.Bold);
            btnAnother.Appearance.ForeColor = Color.White;
            try { btnAnother.Appearance.BackColor = Color.FromArgb(40, 120, 220); } catch { }
            btnAnother.Margin = new Padding(8, 6, 8, 6);
            // Add a circular arrow icon to the button
            try
            {
                var arrow = new Bitmap(24, 24);
                using (var g = Graphics.FromImage(arrow))
                {
                    g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
                    g.Clear(Color.Transparent);
                    using var pen = new Pen(Color.White, 2f);
                    // draw circle arc
                    g.DrawArc(pen, 3, 3, 18, 18, 30, 300);
                    // draw arrow head at end
                    var p1 = new PointF(18f, 6f);
                    var p2 = new PointF(14f, 10f);
                    var p3 = new PointF(20f, 10f);
                    using var brush = new SolidBrush(Color.White);
                    g.FillPolygon(brush, new PointF[] { p1, p2, p3 });
                }
                try { btnAnother.ImageOptions.Image = arrow; btnAnother.ImageOptions.ImageToTextAlignment = DevExpress.XtraEditors.ImageAlignToText.LeftCenter; } catch { btnAnother.Image = arrow; }
            }
            catch { }
            // Fetch alternative suggestion (same genre if provided, or from all when genre is empty)
            btnAnother.Click += (s, e) =>
            {
                try
                {
                    var genreToken = string.IsNullOrWhiteSpace(genre) ? string.Empty : genre;
                    var next = DatabaseHelper.Instance.GetRandomMovieByGenre(genreToken, currentId);
                    if (next == null)
                    {
                        XtraMessageBox.Show("Başka film bulunamadı.", "Bilgi");
                        return;
                    }
                    // update mutable state and UI
                    currentId = next.Value.id;
                    currentName = next.Value.name;
                    currentRating = next.Value.rating;
                    titleLbl.Text = currentName;
                    ratingLbl.Text = $"IMDb: {currentRating:0.0}";
                }
                catch { }
            };

            var btnLater = new DevExpress.XtraEditors.SimpleButton();
            btnLater.Text = "Daha Sonra";
            // match size with other action buttons for visual parity
            btnLater.Size = new Size(160, 48);
            btnLater.Appearance.Font = new Font("Segoe UI", 12, FontStyle.Bold);
            btnLater.Appearance.ForeColor = Color.White;
            try { btnLater.Appearance.BackColor = Color.FromArgb(100, 100, 100); } catch { }
            btnLater.Margin = new Padding(8, 6, 8, 6);
            // add a small clock-like icon on the left
            try
            {
                var clock = new Bitmap(24, 24);
                using (var g = Graphics.FromImage(clock))
                {
                    g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
                    g.Clear(Color.Transparent);
                    using var pen = new Pen(Color.White, 2f);
                    // circle
                    g.DrawEllipse(pen, 3, 3, 18, 18);
                    // hour hand
                    g.DrawLine(pen, 12, 12, 12, 6);
                    // minute hand
                    g.DrawLine(pen, 12, 12, 17, 12);
                }
                try { btnLater.ImageOptions.Image = clock; btnLater.ImageOptions.ImageToTextAlignment = DevExpress.XtraEditors.ImageAlignToText.LeftCenter; } catch { btnLater.Image = clock; }
            }
            catch { }
            btnLater.Click += (s, e) => dlg.Close();

            // Bottom panel to host action buttons so they stay visible
            var bottomPanel = new Panel();
            bottomPanel.Dock = DockStyle.Bottom;
            bottomPanel.Height = 80;
            bottomPanel.BackColor = Color.FromArgb(245, 245, 245);

            // Flow panel to hold buttons side-by-side inside bottom panel
            var fl = new FlowLayoutPanel();
            fl.FlowDirection = FlowDirection.LeftToRight;
            fl.AutoSize = true;
            fl.WrapContents = false;
            fl.Anchor = AnchorStyles.None;
            // add watch, another, then later so Another sits visually between
            fl.Controls.Add(btnWatch);
            fl.Controls.Add(btnAnother);
            fl.Controls.Add(btnLater);
            // place flow panel docked to right within bottom panel with padding
            fl.Location = new Point(bottomPanel.ClientSize.Width - fl.Width - 16, (bottomPanel.Height - fl.Height) / 2);
            fl.Anchor = AnchorStyles.Right | AnchorStyles.Bottom;
            bottomPanel.Controls.Add(fl);

            dlg.Controls.Add(topPanel);
            dlg.Controls.Add(bottomPanel);

            // adjust flow location after layout
            dlg.Shown += (s, e) =>
            {
                fl.Location = new Point(bottomPanel.ClientSize.Width - fl.Width - 16, (bottomPanel.Height - fl.Height) / 2);
            };

            dlg.ShowDialog(this);
        }

        // Tür filtresi
        private void ComboBoxGenres_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                var sel = comboBoxGenres.SelectedItem as string;
                if (string.IsNullOrWhiteSpace(sel) || sel == "Hepsi") { LoadData(); return; }
                var dt = DatabaseHelper.Instance.GetMoviesByGenre(sel);
                try { if (dt != null && dt.Columns.Contains("is_favorite")) dt.Columns.Remove("is_favorite"); } catch { }
                gridControl1.DataSource = dt; ConfigureGrid(dt); UpdateTop5FromDataSource();
            }
            catch { }
        }

        // ESC ile kapatma
        private void Form1_KeyDown(object sender, KeyEventArgs e)
        {
            try
            {
                if (e.KeyCode == Keys.Escape)
                {
                    // If currently viewing favorites, ESC should go back to full list
                    try
                    {
                        if (btnBackFavorites != null && btnBackFavorites.Enabled)
                        {
                            BtnBackFavorites_Click(null, EventArgs.Empty);
                            return;
                        }
                    }
                    catch { }

                    this.Close();
                }
            }
            catch { }
        }

        private void UpdateTop5FromDataSource()
        {
            try
            {
                _top5Ids.Clear(); var dt = this.gridControl1.DataSource as DataTable; if (dt == null || dt.Rows.Count == 0) return;
                var rows = dt.AsEnumerable().OrderByDescending(r => r.Field<double?>("rating") ?? 0.0).ThenBy(r => r.Field<string>("movie_name")).Take(5);
                foreach (var r in rows) { if (dt.Columns.Contains("id") && !r.IsNull("id")) try { _top5Ids.Add(Convert.ToInt32(r["id"])); } catch { } }
            }
            catch { }
        }

        private void EnsureStarImages()
        {
            if (_emptyStar != null && _filledStar != null) return;
            _emptyStar = new Bitmap(16, 16);
            using (var g = Graphics.FromImage(_emptyStar))
            {
                g.Clear(Color.Transparent);
                using var pen = new Pen(Color.FromArgb(140, 140, 140), 1.5f);
                var pts = new PointF[] { new(8,1), new(10.5f,6), new(16,6.5f), new(11.5f,10), new(13,15), new(8,12), new(3,15), new(4.5f,10), new(0,6.5f), new(5.5f,6) };
                g.DrawPolygon(pen, pts);
            }
            _filledStar = new Bitmap(16, 16);
            using (var g = Graphics.FromImage(_filledStar))
            {
                g.Clear(Color.Transparent);
                using var brush = new SolidBrush(Color.FromArgb(255, 193, 7));
                var pts = new PointF[] { new(8,1), new(10.5f,6), new(16,6.5f), new(11.5f,10), new(13,15), new(8,12), new(3,15), new(4.5f,10), new(0,6.5f), new(5.5f,6) };
                g.FillPolygon(brush, pts);
                using var pen = new Pen(Color.FromArgb(120, 90, 0), 0.8f);
                g.DrawPolygon(pen, pts);
            }
        }
    }
}
