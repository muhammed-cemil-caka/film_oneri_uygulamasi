using System;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.Drawing;
using System.Linq;
using System.Windows.Forms;
using DevExpress.XtraEditors;
using DevExpress.XtraGrid.Views.Grid;
using DevExpress.Utils;

namespace DXApplication1
{
    public partial class Form1 : DevExpress.XtraBars.Ribbon.RibbonForm
    {
        // Yıldız görselleri (Favori sütunu için)
        private Bitmap _emptyStar;
        private Bitmap _filledStar;

        // Durum değişkenleri
        private int? _lastRecommendedId = null;
        private HashSet<int> _top5Ids = new HashSet<int>();
        // UI buttons added at runtime
        private DevExpress.XtraEditors.SimpleButton btnFavorites;
        private DevExpress.XtraEditors.SimpleButton btnBackFavorites;

        public Form1()
        {
            InitializeComponent();

            // Form başlangıçta tam ekran
            try { this.WindowState = FormWindowState.Maximized; } catch { }

            // ESC ile kapatma
            this.KeyPreview = true;
            this.KeyDown += Form1_KeyDown;

            try { gridControl1.Dock = DockStyle.Fill; } catch { }

            EnsureStarImages();

            // Veriyi yükle
            LoadData();

            // Favoriler ve Geri butonlarını programatik olarak ekle
            try
            {
                // Style runtime buttons to align with btnRecommend
                btnFavorites = new DevExpress.XtraEditors.SimpleButton();
                btnFavorites.Text = "Favoriler";
                btnFavorites.Size = new System.Drawing.Size(140, 44);
                // align baseline with designer btnRecommend (which is at Y=162)
                btnFavorites.Location = new System.Drawing.Point(290 + 160 + 12, 162);
                btnFavorites.Appearance.Font = new System.Drawing.Font("Segoe UI", 10F, System.Drawing.FontStyle.Regular);
                btnFavorites.Appearance.ForeColor = System.Drawing.Color.White;
                btnFavorites.Appearance.Options.UseFont = true;
                btnFavorites.Appearance.Options.UseForeColor = true;
                btnFavorites.Appearance.BackColor = System.Drawing.Color.FromArgb(60, 60, 60);
                btnFavorites.Appearance.Options.UseBackColor = true;
                btnFavorites.LookAndFeel.UseDefaultLookAndFeel = false;
                btnFavorites.LookAndFeel.Style = DevExpress.LookAndFeel.LookAndFeelStyle.Style3D;
                btnFavorites.Click += BtnFavorites_Click;
                this.Controls.Add(btnFavorites);

                btnBackFavorites = new DevExpress.XtraEditors.SimpleButton();
                btnBackFavorites.Text = "Geri";
                btnBackFavorites.Size = new System.Drawing.Size(100, 44);
                btnBackFavorites.Location = new System.Drawing.Point(btnFavorites.Location.X + btnFavorites.Width + 12, btnFavorites.Location.Y);
                btnBackFavorites.Appearance.Font = new System.Drawing.Font("Segoe UI", 10F, System.Drawing.FontStyle.Regular);
                btnBackFavorites.Appearance.ForeColor = System.Drawing.Color.Black;
                btnBackFavorites.Appearance.Options.UseFont = true;
                btnBackFavorites.Appearance.Options.UseForeColor = true;
                btnBackFavorites.Appearance.BackColor = System.Drawing.Color.FromArgb(245, 245, 245);
                btnBackFavorites.Appearance.Options.UseBackColor = true;
                btnBackFavorites.LookAndFeel.UseDefaultLookAndFeel = false;
                btnBackFavorites.LookAndFeel.Style = DevExpress.LookAndFeel.LookAndFeelStyle.Style3D;
                btnBackFavorites.Click += BtnBackFavorites_Click;
                btnBackFavorites.Enabled = false;
                this.Controls.Add(btnBackFavorites);
            }
            catch { }
        }
        
        // Draw a star at the end of the movie_name cell to indicate favorite status


        
        // Draw a star at the end of the movie_name cell to indicate favorite status
        private void GridView_CustomDrawMovieNameCell(object sender, DevExpress.XtraGrid.Views.Base.RowCellCustomDrawEventArgs e)
        {
            try
            {
                if (e.Column == null || !string.Equals(e.Column.FieldName, "movie_name", StringComparison.OrdinalIgnoreCase)) return;
                var view = sender as GridView;
                if (view == null) return;
                // let default draw occur first
                // draw star on the right side of the cell
                var idObj = view.GetRowCellValue(e.RowHandle, "id");
                bool isFav = false;
                try { if (idObj != null && idObj != DBNull.Value) isFav = DatabaseHelper.Instance.IsFavorite(Convert.ToInt32(idObj)); } catch { }

                // compute position for 16x16 star inside cell
                var rect = e.Bounds;
                int size = 16;
                var starRect = new Rectangle(rect.Right - size - 8, rect.Top + (rect.Height - size) / 2, size, size);
                try
                {
                    var bmp = isFav ? _filledStar : _emptyStar;
                    if (bmp != null)
                    {
                        e.Graphics.DrawImage(bmp, starRect);
                    }
                }
                catch { }
                // ensure text doesn't overlap star: draw text with padding
                e.Appearance.DrawString(e.Cache, e.DisplayText, new Rectangle(rect.Left + 4, rect.Top, rect.Width - size - 12, rect.Height));
                e.Handled = true;
            }
            catch { }
        }

        private void GridView_CustomDrawFavoriteCell(object sender, DevExpress.XtraGrid.Views.Base.RowCellCustomDrawEventArgs e)
        {
            try
            {
                if (e.Column == null || !string.Equals(e.Column.FieldName, "is_favorite", StringComparison.OrdinalIgnoreCase)) return;
                var view = sender as GridView; if (view == null) return;
                var idObj = view.GetRowCellValue(e.RowHandle, "id");
                bool isFav = false;
                try { if (idObj != null && idObj != DBNull.Value) isFav = DatabaseHelper.Instance.IsFavorite(Convert.ToInt32(idObj)); } catch { }

                var rect = e.Bounds;
                int size = 16;
                var starRect = new Rectangle(rect.Left + (rect.Width - size) / 2, rect.Top + (rect.Height - size) / 2, size, size);
                try
                {
                    var bmp = isFav ? _filledStar : _emptyStar;
                    if (bmp != null) e.Graphics.DrawImage(bmp, starRect);
                }
                catch { }
                e.Handled = true;
            }
            catch { }
        }

        private void GridView_DoubleClick(object sender, EventArgs e)
        {
            try
            {
                var view = sender as GridView; if (view == null) return;
                var hi = view.CalcHitInfo(view.GridControl.PointToClient(MousePosition));
                if (hi == null || hi.RowHandle < 0) return;
                var row = view.GetDataRow(hi.RowHandle); if (row == null) return;
                if (row.Table.Columns.Contains("id") && !row.IsNull("id"))
                {
                    int id = Convert.ToInt32(row["id"]);
                    string name = row.Table.Columns.Contains("movie_name") && !row.IsNull("movie_name") ? row.Field<string>("movie_name") : string.Empty;
                    double rating = row.Table.Columns.Contains("rating") && !row.IsNull("rating") ? Convert.ToDouble(row["rating"]) : 0.0;
                    ShowRecommendationDialog(name, rating, id);
                }
            }
            catch { }
        }

        // Sadece rating hücrelerini renklendirir
        private void GridView_CustomDrawRatingCell(object sender, DevExpress.XtraGrid.Views.Base.RowCellCustomDrawEventArgs e)
        {
            try
            {
                if (e.Column == null || !string.Equals(e.Column.FieldName, "rating", StringComparison.OrdinalIgnoreCase)) return;
                object val = gridView1.GetRowCellValue(e.RowHandle, "rating"); double rating = 0.0; try { if (val != null && val != DBNull.Value) rating = Convert.ToDouble(val); } catch { }
                if (rating >= 8.5) e.Appearance.BackColor = Color.FromArgb(235, 248, 236);
                else if (rating >= 7.0) e.Appearance.BackColor = Color.FromArgb(255, 252, 230);
                else e.Appearance.BackColor = Color.FromArgb(255, 241, 243);
                // center rating text
                e.Appearance.TextOptions.HAlignment = HorzAlignment.Center;
            }
            catch { }
        }

        // Designer tarafından çağrılan stub
        private void Form1_Load(object sender, EventArgs e)
        {
            // Yükleme constructor içinde zaten yapıldı; yine de stub mevcut olsun
        }

        private void LoadData()
        {
            try
            {
                var dt = DatabaseHelper.Instance.GetMovies();
                // Ensure movie names are Turkish when possible
                try
                {
                    if (dt != null && dt.Rows.Count > 0 && dt.Columns.Contains("movie_name"))
                    {
                        for (int i = 0; i < dt.Rows.Count; i++)
                        {
                            var row = dt.Rows[i];
                            try
                            {
                                var en = row.Field<string>("movie_name");
                                var tr = DatabaseHelper.Instance.GetTurkishMovieName(en);
                                if (!string.IsNullOrWhiteSpace(tr)) row["movie_name"] = tr;
                            }
                            catch { }
                        }
                    }
                }
                catch { }
                gridControl1.DataSource = dt;

                ConfigureGrid(dt);
                UpdateTop5FromDataSource();

                // Tür listesini doldur
                try
                {
                    if (comboBoxGenres.Items.Count <= 1)
                    {
                        comboBoxGenres.Items.Clear();
                        comboBoxGenres.Items.Add("Hepsi");
                        foreach (var g in DatabaseHelper.Instance.GetDistinctGenres())
                            comboBoxGenres.Items.Add(g);
                        comboBoxGenres.SelectedIndex = 0;
                    }
                }
                catch { }
            }
            catch (Exception ex)
            {
                XtraMessageBox.Show($"Veri yüklenirken hata: {ex.Message}", "Hata", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void ConfigureGrid(DataTable dt)
        {
            try
            {
                // Liste görünümüne dön
                try { gridControl1.MainView = gridView1; gridControl1.ForceInitialize(); } catch { }

                var gv = this.gridView1;
                gv.Columns.Clear();

                // First visible column: sequential row number shown as 'ID'
                var colNo = gv.Columns.AddVisible("row_no", "ID");
                colNo.UnboundType = DevExpress.Data.UnboundColumnType.Integer;
                colNo.OptionsColumn.AllowEdit = false;
                // Keep row number column stable at 75px and prevent auto-resize
                colNo.Width = 75;
                colNo.OptionsColumn.FixedWidth = true;
                colNo.AppearanceCell.TextOptions.HAlignment = HorzAlignment.Center;
                colNo.AppearanceHeader.TextOptions.HAlignment = HorzAlignment.Center;
                colNo.AppearanceHeader.Font = new System.Drawing.Font(colNo.AppearanceHeader.Font, System.Drawing.FontStyle.Bold);
                colNo.AppearanceHeader.ForeColor = System.Drawing.Color.Black;

                // Hidden DB id column (used for updates etc.)
                var colId = gv.Columns.AddVisible("id", "DB_ID"); colId.Visible = false;

                var colName = gv.Columns.AddVisible("movie_name", "FİLMLER"); colName.OptionsColumn.AllowEdit = false; colName.Width = 350;
                // Header style for movie name
                colName.AppearanceHeader.TextOptions.HAlignment = HorzAlignment.Center;
                colName.AppearanceHeader.Font = new System.Drawing.Font(colName.AppearanceHeader.Font, System.Drawing.FontStyle.Bold);
                colName.AppearanceHeader.ForeColor = System.Drawing.Color.Black;

                var colGenre = gv.Columns.AddVisible("genre", "TÜR"); colGenre.OptionsColumn.AllowEdit = false; colGenre.Width = 140;
                var colFav = gv.Columns.AddVisible("is_favorite", "FAVORİ"); colFav.OptionsColumn.AllowEdit = false; colFav.Width = 80;
                colFav.AppearanceHeader.TextOptions.HAlignment = HorzAlignment.Center;
                colFav.AppearanceHeader.Font = new System.Drawing.Font(colFav.AppearanceHeader.Font, System.Drawing.FontStyle.Bold);
                colFav.AppearanceHeader.ForeColor = System.Drawing.Color.Black;
                colFav.AppearanceCell.TextOptions.HAlignment = HorzAlignment.Center;
                colGenre.AppearanceCell.TextOptions.HAlignment = HorzAlignment.Center;
                colGenre.AppearanceHeader.TextOptions.HAlignment = HorzAlignment.Center;
                colGenre.AppearanceHeader.Font = new System.Drawing.Font(colGenre.AppearanceHeader.Font, System.Drawing.FontStyle.Bold);
                colGenre.AppearanceHeader.ForeColor = System.Drawing.Color.Black;

                var colRating = gv.Columns.AddVisible("rating", "PUAN"); colRating.OptionsColumn.AllowEdit = false; colRating.Width = 90;
                colRating.AppearanceHeader.TextOptions.HAlignment = HorzAlignment.Center;
                colRating.AppearanceHeader.Font = new System.Drawing.Font(colRating.AppearanceHeader.Font, System.Drawing.FontStyle.Bold);
                colRating.AppearanceHeader.ForeColor = System.Drawing.Color.Black;

                // Favori sütunu: yıldız simgesini bu sütunda göstereceğiz ve tıklamayı burada yakalayacağız
                EnsureStarImages();

                // Custom draw for the favorite column to show star
                gv.CustomDrawCell -= GridView_CustomDrawFavoriteCell; gv.CustomDrawCell += GridView_CustomDrawFavoriteCell;

                gv.OptionsView.ShowIndicator = false;
                // Allow columns to auto-size to fill available area so right side empty space is reduced
                gv.OptionsView.ColumnAutoWidth = true;
                // Increase row height and fonts for better readability and to occupy more horizontal space
                try
                {
                    gv.RowHeight = 30;
                    gv.Appearance.Row.Font = new System.Drawing.Font("Segoe UI", 10);
                    gv.Appearance.HeaderPanel.Font = new System.Drawing.Font("Segoe UI", 10, System.Drawing.FontStyle.Bold);
                }
                catch { }

                gv.CustomUnboundColumnData -= gridView1_CustomUnboundColumnData; gv.CustomUnboundColumnData += gridView1_CustomUnboundColumnData;
                // Custom draw handlers: rating cell coloring + movie_name cell star icon
                gv.CustomDrawCell -= GridView_CustomDrawRatingCell; gv.CustomDrawCell += GridView_CustomDrawRatingCell;
                gv.CustomDrawCell -= GridView_CustomDrawMovieNameCell; gv.CustomDrawCell += GridView_CustomDrawMovieNameCell;

                // RowStyle not subscribed: coloring will be applied only on rating cells via CustomDrawCell

                // Favori değişikliği yakalama
                gv.CellValueChanged -= GridView_CellValueChanged; gv.CellValueChanged += GridView_CellValueChanged;
                // Double click to open recommendation / detail dialog for the clicked movie
                gv.DoubleClick -= GridView_DoubleClick; gv.DoubleClick += GridView_DoubleClick;
            }
            catch { }
        }

        private void gridView1_CustomUnboundColumnData(object sender, DevExpress.XtraGrid.Views.Base.CustomColumnDataEventArgs e)
        {
            try
            {
                if (e.Column == null) return;
                if (e.Column.FieldName == "row_no" && e.IsGetData)
                {
                    // Provide sequential numbering that reflects the current visible
                    // order after filtering/sorting so numbers don't "mix" when
                    // user uses header filters. Use the view's visible index where possible.
                    var view = sender as GridView;
                    try
                    {
                        if (view != null)
                        {
                            int rowHandle = view.GetRowHandle(e.ListSourceRowIndex);
                            if (rowHandle >= 0)
                            {
                            int visibleIndex = view.GetVisibleIndex(rowHandle);
                                if (visibleIndex >= 0)
                                {
                                    e.Value = visibleIndex + 1;
                                    return;
                                }
                            }
                        }
                    }
                    catch { }

                    // fallback to list source index when visible index cannot be resolved
                    e.Value = e.ListSourceRowIndex + 1;
                }
            }
            catch { }
        }

        // Hem GridView1_RowStyle hem de gridView1_RowStyle ekleniyor (küçük/büyük harf uyumu için)
        private void GridView1_RowStyle(object sender, DevExpress.XtraGrid.Views.Grid.RowStyleEventArgs e)
        {
            ApplyRatingRowStyle(sender as GridView, e);
        }
        private void gridView1_RowStyle(object sender, DevExpress.XtraGrid.Views.Grid.RowStyleEventArgs e)
        {
            ApplyRatingRowStyle(sender as GridView, e);
        }

        private void ApplyRatingRowStyle(GridView view, DevExpress.XtraGrid.Views.Grid.RowStyleEventArgs e)
        {
            try
            {
                if (view == null) return;
                if (e.RowHandle < 0) return;
                object val = view.GetRowCellValue(e.RowHandle, "rating"); double rating = 0.0; try { if (val != null && val != DBNull.Value) rating = Convert.ToDouble(val); } catch { }
                if (rating >= 8.5) e.Appearance.BackColor = Color.FromArgb(235, 248, 236); // pastel yeşil
                else if (rating >= 7.0) e.Appearance.BackColor = Color.FromArgb(255, 252, 230); // pastel sarı
                else e.Appearance.BackColor = Color.FromArgb(255, 241, 243); // pastel kırmızı
            }
            catch { }
        }

        // Favori sütunu değiştiğinde DB'ye kaydet
        private void GridView_CellValueChanged(object sender, DevExpress.XtraGrid.Views.Base.CellValueChangedEventArgs e)
        {
            try
            {
                if (e.Column == null) return;
                if (e.Column.FieldName != "is_favorite") return;
                var view = sender as GridView; if (view == null) return;
                var row = view.GetDataRow(e.RowHandle); if (row == null) return;
                if (!row.Table.Columns.Contains("id") || row.IsNull("id")) return;
                int id = Convert.ToInt32(row["id"]);
                bool val = false; try { val = Convert.ToBoolean(e.Value); } catch { }
                DatabaseHelper.Instance.UpdateFavoriteStatus(id, val);
                UpdateTop5FromDataSource();
            }
            catch { }
        }

        // Designer'ın bağladığı click stub
        private void gridControl1_Click(object sender, EventArgs e)
        {
            // Stub - gerektiğinde genişletilebilir
        }

        private void gridControl1_MouseUp(object sender, MouseEventArgs e)
        {
            try
            {
                var gc = sender as DevExpress.XtraGrid.GridControl;
                if (gc == null) return;
                var view = gc.MainView as GridView;
                if (view == null) return;
                // use the event location (already in gridControl coordinates)
                var pt = e.Location;
                var hi = view.CalcHitInfo(pt);
                if (hi == null || hi.RowHandle < 0 || hi.Column == null) return;
                // Only handle clicks on favorite column
                if (!string.Equals(hi.Column.FieldName, "is_favorite", StringComparison.OrdinalIgnoreCase)) return;

                // compute star rect like in favorite cell draw routine and require the click to be inside it
                // try to obtain cell bounds from hit info via reflection (GridHitInfo.Bounds may exist at runtime)
                var hiType = hi.GetType();
                var boundsProp = hiType.GetProperty("Bounds");
                if (boundsProp == null) return;
                var rectObj = boundsProp.GetValue(hi);
                if (rectObj == null || !(rectObj is Rectangle cellRectScreen)) return;
                // Bounds may be in client coords or screen coords depending on DevExpress version.
                Rectangle cellRect;
                if (cellRectScreen.Left >= 0 && cellRectScreen.Top >= 0 && cellRectScreen.Right <= gc.Width && cellRectScreen.Bottom <= gc.Height)
                {
                    // likely already in grid client coordinates
                    cellRect = cellRectScreen;
                }
                else
                {
                    // convert from screen to grid client coordinates
                    var topLeftClient = gc.PointToClient(new Point(cellRectScreen.Left, cellRectScreen.Top));
                    cellRect = new Rectangle(topLeftClient.X, topLeftClient.Y, cellRectScreen.Width, cellRectScreen.Height);
                }
                int size = 16;
                var starRect = new Rectangle(cellRect.Left + (cellRect.Width - size) / 2, cellRect.Top + (cellRect.Height - size) / 2, size, size);
                if (!starRect.Contains(pt)) return; // only toggle when clicking the star area

                // Toggle favorite when user clicks the star area
                var idObj = view.GetRowCellValue(hi.RowHandle, "id");
                if (idObj == null || idObj == DBNull.Value) return;
                int id = Convert.ToInt32(idObj);
                bool currently = DatabaseHelper.Instance.IsFavorite(id);
                DatabaseHelper.Instance.UpdateFavoriteStatus(id, !currently);
                // refresh view
                view.RefreshRow(hi.RowHandle);
            }
            catch { }
        }

        private void BtnFavorites_Click(object? sender, EventArgs e)
        {
            try
            {
                var dt = DatabaseHelper.Instance.GetFavoriteMovies();
                gridControl1.DataSource = dt; ConfigureGrid(dt); UpdateTop5FromDataSource();
                btnFavorites.Enabled = false; btnBackFavorites.Enabled = true;
            }
            catch { }
        }

        private void BtnBackFavorites_Click(object? sender, EventArgs e)
        {
            try
            {
                LoadData();
                btnFavorites.Enabled = true; btnBackFavorites.Enabled = false;
            }
            catch { }
        }

        // Öneri butonu
        private void BtnRecommend_Click(object sender, EventArgs e)
        {
            try
            {
                var sel = comboBoxGenres.SelectedItem as string;
                if (string.IsNullOrWhiteSpace(sel) || sel == "Hepsi") { XtraMessageBox.Show("Lütfen önce bir tür seçin.", "Bilgi"); return; }
                var movie = DatabaseHelper.Instance.GetRandomMovieByGenre(sel, _lastRecommendedId);
                if (movie == null) { XtraMessageBox.Show("Seçilen türe ait film bulunamadı.", "Bilgi"); return; }
                _lastRecommendedId = movie.Value.id;

                // Öneri dialogu
                ShowRecommendationDialog(movie.Value.name, movie.Value.rating, movie.Value.id);
            }
            catch { }
        }

        private void ShowRecommendationDialog(string name, double rating, int? id = null)
        {
            using var dlg = new XtraForm();
            // allow ESC to close the dialog
            dlg.KeyPreview = true;
            dlg.KeyDown += (s, e) => { try { if (e.KeyCode == System.Windows.Forms.Keys.Escape) dlg.Close(); } catch { } };
            dlg.Text = "Film Önerisi";
            dlg.StartPosition = FormStartPosition.CenterParent;
            // Adjusted size to focus on title/rating and action buttons
            dlg.Size = new Size(620, 260);
            dlg.FormBorderStyle = FormBorderStyle.FixedDialog;

            // Top area: cinematic icons and title/rating centered
            var topPanel = new Panel { Dock = DockStyle.Top, Height = 140, BackColor = Color.FromArgb(30, 30, 30) };

            // Decorative cinematic icon (simple film strip drawn into PictureBox)
            // Create a nicer clapperboard-like icon programmatically
            var pic = new PictureBox { Size = new Size(96, 96), Location = new Point(18, 18), SizeMode = PictureBoxSizeMode.CenterImage };
            var bmp = new Bitmap(96, 96);
            using (var g = Graphics.FromImage(bmp))
            {
                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
                g.Clear(Color.Transparent);
                // body (rounded rectangle)
                using var bodyBrush = new SolidBrush(Color.FromArgb(40, 40, 40));
                using (var path = new System.Drawing.Drawing2D.GraphicsPath())
                {
                    int x = 12, y = 30, w = 72, h = 46, r = 8;
                    path.AddArc(x, y, r * 2, r * 2, 180, 90);
                    path.AddArc(x + w - r * 2, y, r * 2, r * 2, 270, 90);
                    path.AddArc(x + w - r * 2, y + h - r * 2, r * 2, r * 2, 0, 90);
                    path.AddArc(x, y + h - r * 2, r * 2, r * 2, 90, 90);
                    path.CloseFigure();
                    g.FillPath(bodyBrush, path);
                }
                // top clapper (angled stripes)
                using var topBrush = new SolidBrush(Color.FromArgb(60, 60, 60));
                var topRect = new System.Drawing.Drawing2D.GraphicsPath();
                topRect.AddPolygon(new PointF[] { new(8, 24), new(88, 12), new(84, 20), new(12, 34) });
                g.FillPath(topBrush, topRect);
                // stripes
                using var stripeBrush = new SolidBrush(Color.FromArgb(200, 200, 200));
                for (int i = 0; i < 4; i++)
                    g.FillRectangle(stripeBrush, 16 + i * 14, 18, 8, 6);
                // play triangle in center
                using var playBrush = new SolidBrush(Color.FromArgb(255, 215, 64));
                var tri = new PointF[] { new(44, 42), new(64, 50), new(44, 58) };
                g.FillPolygon(playBrush, tri);
                using var borderPen = new Pen(Color.FromArgb(220, 220, 220), 1f);
                g.DrawPolygon(borderPen, tri);
            }
            pic.Image = bmp;
            topPanel.Controls.Add(pic);

            var titleLbl = new Label();
            titleLbl.Text = name; titleLbl.ForeColor = Color.White; titleLbl.Font = new Font("Segoe UI", 20, FontStyle.Bold);
            titleLbl.AutoSize = false; titleLbl.TextAlign = ContentAlignment.MiddleCenter; titleLbl.Location = new Point(130, 12); titleLbl.Size = new Size(460, 52);
            topPanel.Controls.Add(titleLbl);

            var ratingLbl = new Label(); ratingLbl.Text = $"IMDb: {rating:0.0}"; ratingLbl.ForeColor = Color.LightGoldenrodYellow; ratingLbl.Font = new Font("Segoe UI", 14, FontStyle.Regular);
            ratingLbl.AutoSize = false; ratingLbl.TextAlign = ContentAlignment.MiddleCenter; ratingLbl.Location = new Point(130, 70); ratingLbl.Size = new Size(460, 28);
            topPanel.Controls.Add(ratingLbl);
            // Bottom-right action buttons
            var btnWatch = new DevExpress.XtraEditors.SimpleButton();
            btnWatch.Text = "İZLE";
            btnWatch.Size = new Size(160, 48);
            btnWatch.Appearance.Font = new Font("Segoe UI", 12, FontStyle.Bold);
            btnWatch.Appearance.ForeColor = Color.White;
            try { btnWatch.Appearance.BackColor = Color.FromArgb(220, 80, 80); } catch { }
            btnWatch.Margin = new Padding(8, 6, 8, 6);
            btnWatch.Click += (s, e) =>
            {
                try
                {
                    var query = System.Net.WebUtility.UrlEncode(name + " imdb izle");
                    var url = $"https://www.google.com/search?q={query}";
                    Process.Start(new ProcessStartInfo { FileName = url, UseShellExecute = true });
                }
                catch { }
            };

            var btnLater = new DevExpress.XtraEditors.SimpleButton();
            btnLater.Text = "Daha Sonra";
            btnLater.Size = new Size(120, 36);
            btnLater.Appearance.Font = new Font("Segoe UI", 10, FontStyle.Regular);
            btnLater.Margin = new Padding(8, 16, 8, 12);
            btnLater.Click += (s, e) => dlg.Close();

            // Bottom panel to host action buttons so they stay visible
            var bottomPanel = new Panel();
            bottomPanel.Dock = DockStyle.Bottom;
            bottomPanel.Height = 80;
            bottomPanel.BackColor = Color.FromArgb(245, 245, 245);

            // Flow panel to hold buttons side-by-side inside bottom panel
            var fl = new FlowLayoutPanel();
            fl.FlowDirection = FlowDirection.LeftToRight;
            fl.AutoSize = true;
            fl.WrapContents = false;
            fl.Anchor = AnchorStyles.None;
            fl.Controls.Add(btnWatch);
            fl.Controls.Add(btnLater);
            // place flow panel docked to right within bottom panel with padding
            fl.Location = new Point(bottomPanel.ClientSize.Width - fl.Width - 16, (bottomPanel.Height - fl.Height) / 2);
            fl.Anchor = AnchorStyles.Right | AnchorStyles.Bottom;
            bottomPanel.Controls.Add(fl);

            dlg.Controls.Add(topPanel);
            dlg.Controls.Add(bottomPanel);

            // adjust flow location after layout
            dlg.Shown += (s, e) =>
            {
                fl.Location = new Point(bottomPanel.ClientSize.Width - fl.Width - 16, (bottomPanel.Height - fl.Height) / 2);
            };

            dlg.ShowDialog(this);
        }

        // Tür filtresi
        private void ComboBoxGenres_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                var sel = comboBoxGenres.SelectedItem as string;
                if (string.IsNullOrWhiteSpace(sel) || sel == "Hepsi") { LoadData(); return; }
                var dt = DatabaseHelper.Instance.GetMoviesByGenre(sel);
                try { if (dt != null && dt.Columns.Contains("is_favorite")) dt.Columns.Remove("is_favorite"); } catch { }
                gridControl1.DataSource = dt; ConfigureGrid(dt); UpdateTop5FromDataSource();
            }
            catch { }
        }

        // ESC ile kapatma
        private void Form1_KeyDown(object sender, KeyEventArgs e)
        {
            try
            {
                if (e.KeyCode == Keys.Escape)
                {
                    // If currently viewing favorites, ESC should go back to full list
                    try
                    {
                        if (btnBackFavorites != null && btnBackFavorites.Enabled)
                        {
                            BtnBackFavorites_Click(null, EventArgs.Empty);
                            return;
                        }
                    }
                    catch { }

                    this.Close();
                }
            }
            catch { }
        }

        private void UpdateTop5FromDataSource()
        {
            try
            {
                _top5Ids.Clear(); var dt = this.gridControl1.DataSource as DataTable; if (dt == null || dt.Rows.Count == 0) return;
                var rows = dt.AsEnumerable().OrderByDescending(r => r.Field<double?>("rating") ?? 0.0).ThenBy(r => r.Field<string>("movie_name")).Take(5);
                foreach (var r in rows) { if (dt.Columns.Contains("id") && !r.IsNull("id")) try { _top5Ids.Add(Convert.ToInt32(r["id"])); } catch { } }
            }
            catch { }
        }

        private void EnsureStarImages()
        {
            if (_emptyStar != null && _filledStar != null) return;
            _emptyStar = new Bitmap(16, 16);
            using (var g = Graphics.FromImage(_emptyStar))
            {
                g.Clear(Color.Transparent);
                using var pen = new Pen(Color.FromArgb(140, 140, 140), 1.5f);
                var pts = new PointF[] { new(8,1), new(10.5f,6), new(16,6.5f), new(11.5f,10), new(13,15), new(8,12), new(3,15), new(4.5f,10), new(0,6.5f), new(5.5f,6) };
                g.DrawPolygon(pen, pts);
            }
            _filledStar = new Bitmap(16, 16);
            using (var g = Graphics.FromImage(_filledStar))
            {
                g.Clear(Color.Transparent);
                using var brush = new SolidBrush(Color.FromArgb(255, 193, 7));
                var pts = new PointF[] { new(8,1), new(10.5f,6), new(16,6.5f), new(11.5f,10), new(13,15), new(8,12), new(3,15), new(4.5f,10), new(0,6.5f), new(5.5f,6) };
                g.FillPolygon(brush, pts);
                using var pen = new Pen(Color.FromArgb(120, 90, 0), 0.8f);
                g.DrawPolygon(pen, pts);
            }
        }
    }
}
