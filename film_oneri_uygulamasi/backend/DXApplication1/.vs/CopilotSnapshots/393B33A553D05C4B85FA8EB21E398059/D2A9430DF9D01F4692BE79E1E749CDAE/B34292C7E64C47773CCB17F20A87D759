using System;
using System.Data;
using System.Configuration;
using Npgsql;

namespace DXApplication1
{
    public static class DatabaseHelper
    {
        // Reads connection string from <connectionStrings> PostgresConnection; if missing, builds from appSettings keys.
        private static string GetConnectionString()
        {
            var cs = ConfigurationManager.ConnectionStrings["PostgresConnection"]?.ConnectionString;
            if (!string.IsNullOrWhiteSpace(cs))
                return cs;

            // Fallback: read individual keys from appSettings
            var host = ConfigurationManager.AppSettings["Host"] ?? "localhost";
            var port = ConfigurationManager.AppSettings["Port"] ?? "5432";
            var database = ConfigurationManager.AppSettings["Database"] ?? "postgres";
            var user = ConfigurationManager.AppSettings["UserId"] ?? "postgres";
            var password = ConfigurationManager.AppSettings["Password"] ?? "";

            return $"Host={host};Port={port};Username={user};Password={password};Database={database}";
        }

        // Returns all movies from Movies table as a DataTable
        public static DataTable GetMovies()
        {
            var dt = new DataTable();
            var connString = GetConnectionString();

            using var conn = new NpgsqlConnection(connString);
            using var cmd = new NpgsqlCommand("SELECT id, movie_name, genre, rating FROM Movies ORDER BY id", conn);
            using var adapter = new NpgsqlDataAdapter(cmd);
            adapter.Fill(dt);

            return dt;
        }
    }
}
