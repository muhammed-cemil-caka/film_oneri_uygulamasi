using System;
using System.Data;
using System.Configuration;
using Npgsql;
using DevExpress.XtraEditors;
using System.Windows.Forms;

namespace DXApplication1
{
    // Singleton DatabaseHelper using Npgsql
    public sealed class DatabaseHelper
    {
        private static readonly Lazy<DatabaseHelper> _instance = new(() => new DatabaseHelper());
        public static DatabaseHelper Instance => _instance.Value;

        private readonly string _connectionString;

        private DatabaseHelper()
        {
            // Use the requested hard-coded connection string
            _connectionString = "Host=localhost;Port=5432;Username=postgres;Database=film_db";
        }

        // Special targeted fixes
        private int FixIndianaJonesRatings()
        {
            int updated = 0;
            try
            {
                var client = new OmdbClient(ConfigurationManager.AppSettings["OmdbApiKey"]);
                // Find records containing common misspelling 'Iniana' or 'Indiana Jones' with zero rating
                using var conn = new NpgsqlConnection(_connectionString);
                using var cmd = new NpgsqlCommand("SELECT id, movie_name, release_year FROM movies WHERE (movie_name ILIKE '%iniana%' OR movie_name ILIKE '%indiana jones%') AND (rating IS NULL OR rating = 0.0)", conn);
                conn.Open();
                using var reader = cmd.ExecuteReader();
                var list = new System.Collections.Generic.List<(int id, string name, int? year)>();
                while (reader.Read())
                {
                    int id = reader.GetInt32(0);
                    string name = reader.GetString(1);
                    int? year = reader.IsDBNull(2) ? null : reader.GetInt32(2);
                    list.Add((id, name, year));
                }
                reader.Close();

                foreach (var item in list)
                {
                    // Try franchise canonical titles
                    var franchise = new[] {
                        ("Raiders of the Lost Ark", 1981),
                        ("Indiana Jones and the Temple of Doom", 1984),
                        ("Indiana Jones and the Last Crusade", 1989),
                        ("Indiana Jones and the Kingdom of the Crystal Skull", 2008)
                    };
                    double? found = null;
                    foreach (var f in franchise)
                    {
                        var r = System.Threading.Tasks.Task.Run(() => client.GetImdbRatingAsync(f.Item1, f.Item2)).Result;
                        if (r == null)
                            r = System.Threading.Tasks.Task.Run(() => client.SearchAndGetRatingAsync(f.Item1, f.Item2)).Result;
                        if (r != null && r > 0)
                        {
                            found = r;
                            break;
                        }
                    }

                    if (found != null)
                    {
                        decimal safe = Convert.ToDecimal(found.Value, System.Globalization.CultureInfo.InvariantCulture);
                        if (UpdateMovieRating(item.id, safe)) updated++;
                    }
                }
            }
            catch { }
            return updated;
        }

        // Public wrapper so UI or startup can trigger the Indiana Jones fix
        public int FixIndianaJonesRatingsPublic()
        {
            return FixIndianaJonesRatings();
        }

        // Try to re-fetch and update movies whose rating remains 0.0 (retry once)
        public int RetryZeroRatingsFromOmdb()
        {
            var apiKey = ConfigurationManager.AppSettings["OmdbApiKey"];
            if (string.IsNullOrWhiteSpace(apiKey))
            {
                XtraMessageBox.Show("OMDb API anahtarı App.config içinde ayarlı değil. Lütfen OmdbApiKey ekleyin.", "OMDb Hatası", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return -1;
            }

            int updated = 0;
            try
            {
                var client = new OmdbClient(apiKey);
                var zeros = GetMoviesWithZeroRating();
                foreach (var item in zeros)
                {
                    // try direct lookup first, then fallback to search and variants, using logging helper
                    var rating = System.Threading.Tasks.Task.Run(() => client.GetImdbRatingWithFallbackAsync(item.name, item.year)).Result;

                    // Special-case: if still null and title looks like 'Indiana Jones' (or common misspellings), try franchise map
                    if ((rating == null || rating == 0) && (item.name.IndexOf("indiana", StringComparison.OrdinalIgnoreCase) >= 0 || item.name.IndexOf("iniana", StringComparison.OrdinalIgnoreCase) >= 0))
                    {
                        var franchise = new[] {
                            "Raiders of the Lost Ark",
                            "Indiana Jones and the Temple of Doom",
                            "Indiana Jones and the Last Crusade",
                            "Indiana Jones and the Kingdom of the Crystal Skull"
                        };
                        foreach (var f in franchise)
                        {
                            var fr = System.Threading.Tasks.Task.Run(() => client.GetImdbRatingAsync(f)).Result;
                            if (fr == null)
                                fr = System.Threading.Tasks.Task.Run(() => client.SearchAndGetRatingAsync(f)).Result;
                            if (fr != null && fr > 0)
                            {
                                rating = fr;
                                break;
                            }
                        }
                    }

                    if (rating != null && rating > 0)
                    {
                        decimal safeRating = Convert.ToDecimal(rating, System.Globalization.CultureInfo.InvariantCulture);
                        if (UpdateMovieRating(item.id, safeRating)) updated++;
                    }
                }
            }
            catch (Exception ex)
            {
                XtraMessageBox.Show($"Retry sırasında hata: {ex}", "OMDb Hatası", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return -1;
            }

            return updated;
        }

        // Returns list of movies (id,name,release_year) where rating is 0.0
        public System.Collections.Generic.List<(int id, string name, int? year)> GetMoviesWithZeroRating()
        {
            var list = new System.Collections.Generic.List<(int id, string name, int? year)>();
            try
            {
                using var conn = new NpgsqlConnection(_connectionString);
                using var cmd = new NpgsqlCommand("SELECT DISTINCT id, movie_name, release_year FROM movies WHERE rating IS NULL OR rating = 0.0 ORDER BY id", conn);
                conn.Open();
                using var reader = cmd.ExecuteReader();
                while (reader.Read())
                {
                    int id = reader.GetInt32(0);
                    string name = reader.GetString(1);
                    int? year = reader.IsDBNull(2) ? null : reader.GetInt32(2);
                    list.Add((id, name, year));
                }
            }
            catch (Exception ex)
            {
                XtraMessageBox.Show($"Veritabanı hatası (listeleme): {ex.Message}", "Hata", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

            return list;
        }

        // Update a single movie's rating
        public bool UpdateMovieRating(int id, decimal rating)
        {
            try
            {
                using var conn = new NpgsqlConnection(_connectionString);
                using var cmd = new NpgsqlCommand("UPDATE movies SET rating = @r WHERE id = @id", conn);
                cmd.Parameters.AddWithValue("@r", rating);
                cmd.Parameters.AddWithValue("@id", id);
                conn.Open();
                var rows = cmd.ExecuteNonQuery();
                return rows > 0;
            }
            catch (Exception ex)
            {
                XtraMessageBox.Show($"Veritabanı hatası (güncelleme): {ex.Message}", "Hata", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return false;
            }
        }

        // Returns all movies from Movies table as a DataTable
        public DataTable GetMovies()
        {
            var dt = new DataTable();

            try
            {
                using var conn = new NpgsqlConnection(_connectionString);
                // include a sequential row number for consistent display
                using var cmd = new NpgsqlCommand("SELECT row_number() OVER (ORDER BY id) AS seq, id, movie_name, genre, COALESCE(rating,0.0) AS rating FROM movies ORDER BY id", conn);
                using var adapter = new NpgsqlDataAdapter(cmd);
                // open explicitly to catch connection issues early
                conn.Open();
                adapter.Fill(dt);
            }
            catch (Exception ex)
            {
                // Show full exception to help troubleshooting (includes inner exceptions and stack trace)
                XtraMessageBox.Show($"Veritabanı bağlantı hatası:\n{ex}", "Veritabanı Hatası", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

            return dt;
        }

        // Attempts to open a connection and returns null on success or the error message on failure
        public string? TestConnection()
        {
            try
            {
                using var conn = new NpgsqlConnection(_connectionString);
                conn.Open();
                conn.Close();
                return null;
            }
            catch (Exception ex)
            {
                return ex.ToString();
            }
        }

        // Updates ratings for existing movies by querying OMDb. Returns number of updated rows or -1 on error.
        public int UpdateRatingsFromOmdb()
        {
            var apiKey = ConfigurationManager.AppSettings["OmdbApiKey"];
            if (string.IsNullOrWhiteSpace(apiKey))
            {
                XtraMessageBox.Show("OMDb API anahtarı App.config içinde ayarlı değil. Lütfen OmdbApiKey ekleyin.", "OMDb Hatası", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return -1;
            }

            try
            {
                var client = new OmdbClient(apiKey);

                // Load movie info (id,name,year) where rating is still 0.0
                var zeros = GetMoviesWithZeroRating();

                int updated = 0;
                foreach (var item in zeros)
                {
                    // use robust fallback lookup which may use year
                    var rating = System.Threading.Tasks.Task.Run(() => client.GetImdbRatingWithFallbackAsync(item.name, item.year)).Result;

                    if (rating != null && rating > 0)
                    {
                        using var conn = new NpgsqlConnection(_connectionString);
                        using var cmd = new NpgsqlCommand("UPDATE movies SET rating = @r WHERE id = @id", conn);

                        // Kültür farkını (nokta-virgül ayrımı) ortadan kaldırmak için InvariantCulture kullanın
                        decimal safeRating = Convert.ToDecimal(rating, System.Globalization.CultureInfo.InvariantCulture);

                        cmd.Parameters.AddWithValue("@r", safeRating);
                        cmd.Parameters.AddWithValue("@id", item.id);
                        conn.Open();
                        var rows = cmd.ExecuteNonQuery();
                        if (rows > 0) updated += rows;
                    }
                }

                XtraMessageBox.Show($"Güncelleme tamamlandı. Güncellenen satır sayısı: {updated}", "OMDb", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return updated;
            }
            catch (Exception ex)
            {
                XtraMessageBox.Show($"OMDb güncelleme hatası:\n{ex}", "OMDb Hatası", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return -1;
            }
        }
    }
}
