using System.Net.Http;
using System.Text.Json;
using System.Threading.Tasks;

namespace DXApplication1
{
    internal class OmdbClient
    {
        private readonly HttpClient _http;
        private readonly string _apiKey;

        public OmdbClient(string apiKey)
        {
            _apiKey = apiKey;
            _http = new HttpClient();
        }

        public async Task<double?> GetImdbRatingAsync(string title)
        {
            // OMDb API: http://www.omdbapi.com/?t={title}&apikey={apikey}
            var q = Uri.EscapeDataString(title);
            var url = $"http://www.omdbapi.com/?t={q}&apikey={_apiKey}";
            var res = await _http.GetAsync(url);
            if (!res.IsSuccessStatusCode) return null;
            using var stream = await res.Content.ReadAsStreamAsync();
            var doc = await JsonDocument.ParseAsync(stream);
            if (doc.RootElement.TryGetProperty("imdbRating", out var ratingEl))
            {
                var s = ratingEl.GetString();
                if (double.TryParse(s, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var r))
                    return r;
            }
            return null;
        }
    }
}
